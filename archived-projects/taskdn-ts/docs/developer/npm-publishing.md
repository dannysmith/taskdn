# npm Publishing

This document covers how the `taskdn-sdk` package is built and published to npm.

## Package Structure

The SDK is published as multiple packages:

| Package | Contents |
|---------|----------|
| `taskdn-sdk` | Main package with JS bindings and type definitions |
| `taskdn-sdk-darwin-arm64` | macOS Apple Silicon native binary |
| `taskdn-sdk-darwin-x64` | macOS Intel native binary |
| `taskdn-sdk-linux-x64-gnu` | Linux x64 (glibc) native binary |
| `taskdn-sdk-win32-x64-msvc` | Windows x64 native binary |

The main package lists the platform packages as `optionalDependencies`. When users install `taskdn-sdk`, npm automatically installs only the binary for their platform.

## How It Works

### Build Process

1. **NAPI-RS** compiles the Rust code to native Node.js addons (`.node` files)
2. Each platform produces a binary named like `taskdn.darwin-arm64.node`
3. The `index.js` file (generated by NAPI-RS) detects the platform and loads the correct binary

### Platform Detection

The generated `index.js` handles:
- Platform detection (darwin, linux, win32)
- Architecture detection (arm64, x64)
- libc detection on Linux (glibc vs musl)
- Fallback error messages if no matching binary is found

## CI/CD Workflow

The GitHub Actions workflow (`.github/workflows/publish-ts-package.yml`) handles:

### Jobs

1. **lint** - Runs `cargo fmt` and `clippy` checks
2. **build** - Builds native binaries for all 4 platforms in parallel
3. **test** - Tests binaries on each platform with Node 20 and 22
4. **publish** - Publishes to npm (only on main, when commit matches version pattern)

### Build Matrix

| Runner | Target | Notes |
|--------|--------|-------|
| `macos-latest` | `aarch64-apple-darwin` | Apple Silicon |
| `macos-13` | `x86_64-apple-darwin` | Intel Mac (macos-13 still has x64) |
| `ubuntu-latest` | `x86_64-unknown-linux-gnu` | Uses `--use-napi-cross` |
| `windows-latest` | `x86_64-pc-windows-msvc` | MSVC toolchain |

## Publishing

### Automatic Publishing

Publishing happens automatically when:
1. A commit is pushed to `main`
2. The commit message matches a version pattern (e.g., `0.1.1` or `0.2.0-beta.1`)

Version patterns:
- `X.Y.Z` - Published as `latest` tag
- `X.Y.Z-*` - Published as `next` tag (for prereleases)

### Manual Version Bump

```bash
# Bump version (creates commit and tag)
npm version patch  # 0.1.0 -> 0.1.1
npm version minor  # 0.1.0 -> 0.2.0
npm version major  # 0.1.0 -> 1.0.0

# Push with tags to trigger publish
git push --follow-tags
```

### Trusted Publishing (OIDC)

This package uses npm's OIDC-based trusted publishing:

- **No NPM_TOKEN secret needed** - GitHub Actions authenticates directly with npm
- **Provenance attestation** - Published packages include cryptographic proof of their build origin
- **Configured on npm** - The npm package settings link to this GitHub repo and workflow

#### How OIDC Works

1. GitHub Actions requests an OIDC token from GitHub's identity provider
2. The token is sent to npm during `npm publish --provenance`
3. npm verifies the token matches the configured repository and workflow
4. Package is published with provenance attestation

#### Required Workflow Permissions

```yaml
permissions:
  contents: write    # For creating releases (optional)
  id-token: write    # Required for OIDC token
```

## Local Development

### Regenerating Platform Packages

If you need to regenerate the `npm/` directory:

```bash
rm -rf npm/
bun run napi create-npm-dirs
```

### Testing the Build Locally

```bash
# Debug build (faster, current platform only)
bun run build:debug

# Release build (optimized)
bun run build

# Test
bun test
```

### Dry Run Publish

```bash
npm pack --dry-run
```

## Troubleshooting

### "Scope not found" Error

If publishing fails with "Scope not found", you're using a scoped package name (`@scope/name`) but the npm organization doesn't exist. Either:
1. Create the organization on npmjs.com
2. Use an unscoped package name (like `taskdn-sdk`)

### OIDC Authentication Fails

Check that:
1. Trusted publishing is configured on npmjs.com for this package
2. The repository and workflow file match exactly
3. The workflow has `id-token: write` permission

### Platform Binary Not Found

If users report "Cannot find native binding":
1. Check the platform is in our build matrix
2. Verify the optionalDependency is listed in `package.json`
3. Check the platform package was published correctly

## Adding New Platforms

To add a new platform:

1. Add the target to `package.json` under `napi.targets`
2. Add the optionalDependency to `package.json`
3. Add the build configuration to the CI workflow
4. Regenerate npm directories: `bun run napi create-npm-dirs`
5. Test the build on that platform
